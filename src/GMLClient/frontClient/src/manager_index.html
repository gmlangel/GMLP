<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>接口调用测试</title>
    <style type="text/css">
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
    </style>
    <script type="text/javascript" src="./jq.js"></script>
    <script type="text/javascript" src="./interfaceExec.js"></script>
    <script type="text/javascript" src="./gmlCustom.js"></script>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./gml.css">
    <!-- 用户信息编辑的工具条 -->
    <script type="text/html" id="table_userlist_barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="roleinfo_des" id="roleinfo_des">权限详细</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit_userinfo" lay-filter="edit_userinfo">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete_userinfo" lay-filter="delete_userinfo">删除</a>
    </script>

    <!-- 条件信息编辑的工具条 -->
    <script type="text/html" id="table_condition_bar">
        <a class="layui-btn layui-btn-xs" lay-event="btn_edit_condition" lay-filter="btn_edit_condition">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="btn_delete_condition" lay-filter="btn_delete_condition">删除</a>
    </script>

</head>
<!-- 编辑/新增用户信息模板 -->
<form style="display:none;width:300px;" class="layui-form" lay-filter="panel_editUserinfo" id="panel_editUserinfo">
    <!-- 提示：如果你不想用form，你可以换成div等任何一个普通元素 -->
    <div class="layui-form-item" style="padding-top: 30px;">
        <label class="layui-form-label">用户名</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required|email" placeholder="请输入" autocomplete="off"
                class="layui-input" id="tb_edit_name">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required|pwdreg" placeholder="请输入" autocomplete="off"
                class="layui-input" id="tb_edit_pwd">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">角色</label>
        <div class="layui-input-block">
            <select lay-filter="rolelist" id="rolelist">
                <option value="0">写作</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="editUser_cancel"
                id="editUser_cancel">取消</button>
            <button class="layui-btn" lay-submit lay-filter="editUser_commit" id="editUser_commit">提交</button>
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="addUser_cancel" id="addUser_cancel"
                style="display: none;">取消</button>
            <button class="layui-btn" lay-submit lay-filter="addUser_commit" id="addUser_commit"
                style="display: none;">提交</button>
        </div>
    </div>
</form>

<!-- 新增条件类型信息模板 -->
<form style="display:none;width:300px;" class="layui-form" lay-filter="panel_addConditionType"
    id="panel_addConditionType">
    <div class="layui-form-item" style="padding-top: 30px;">
        <label class="layui-form-label">中文名</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input"
                id="tb_add_conditionType_zh">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">英文名</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input"
                id="tb_add_conditionType_en">
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">请填写描述</label>
        <div class="layui-input-block">
            <textarea placeholder="请输入内容" class="layui-textarea" id="tb_add_conditionType_des"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_addConditionType_cancel"
                id="btn_addConditionType_cancel">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_addConditionType_commit"
                id="btn_addConditionType_commit">提交</button>
        </div>
    </div>
</form>

<!-- 编辑/新增条件信息模板 -->
<form style="display:none;width:300px;" class="layui-form" lay-filter="panel_addCondition" id="panel_addCondition">
    <div class="layui-form-item" style="padding-top: 30px;">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input"
                id="tb_add_conditionName">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">条件类型</label>
        <div class="layui-input-block">
            <select lay-filter="cTypelist" id="cTypelist">
                <option value="0">请选择</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">条件值</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input"
                id="tb_add_conditionValue">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">生效几率</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required|number" placeholder="请输入" autocomplete="off"
                class="layui-input" id="tb_add_probability">
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">描述</label>
        <div class="layui-input-block">
            <textarea placeholder="描述..." class="layui-textarea" id="tb_add_condition_des"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_addCondition_cancel"
                id="btn_addCondition_cancel">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_addCondition_commit"
                id="btn_addCondition_commit">提交</button>
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_editCondition_cancel"
                id="btn_editCondition_cancel">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_editCondition_commit"
                id="btn_editCondition_commit">提交</button>
        </div>
    </div>
</form>

<!-- 编辑/新增策略类别信息模板 -->
<form style="display:none;width:500px;" class="layui-form" lay-filter="panel_addStrategyCategroy"
    id="panel_addStrategyCategroy">
    <div class="layui-form-item" style="padding-top: 30px;">
        <label class="layui-form-label">类别名称</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input"
                id="tb_add_scName">
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">类别模板</label>
        <div class="layui-input-block">
            <textarea placeholder='策略模板内容,如：
        {
                 "strategyName":{
                      "type":"string",
                      "def_v":"1对1教室策略",
                      "des":"策略名称"
                 },
                 "canSendImg":{
                      "type":"bool",
                      "def_v":1,
                      "des":"是否允许发送图片"
                 }
        }' class="layui-textarea" lay-verify="required" style="height: 220px;" id="tb_add_sc_template"></textarea>
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">描述</label>
        <div class="layui-input-block">
            <textarea placeholder="描述..." class="layui-textarea" id="tb_add_sc_des"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_addSC_cancel" id="btn_addSC_cancel"
                style="margin-left:120px;">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_addSC_commit" id="btn_addSC_commit">提交</button>
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_editSC_cancel" id="btn_editSC_cancel"
                style="margin-left:120px;">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_editSC_commit" id="btn_editSC_commit">提交</button>
        </div>
    </div>
</form>

<!-- 新增/编辑策略信息 的模板 -->
<form style="display:none;width:540px;" class="layui-form" lay-filter="panel_addStrategy" id="panel_addStrategy">
    <div class="layui-form-item" style="padding-top: 30px;">
        <label class="layui-form-label">策略名称</label>
        <div class="layui-input-block">
            <input type="text" name="" lay-verify="required" placeholder="请输入" autocomplete="off" class="layui-input"
                id="tb_add_SName">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">过期时间</label>
        <div class="layui-inline">
            <input type="text" class="layui-input" lay-verify="required" id="tb_add_SDate">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">是否启用</label>
        <div class="layui-input-block">
            <input type="checkbox" lay-skin="switch" id="tb_add_SEnabled" checked>
        </div>
    </div>
    <div id="StrategyCustomData">

    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_addStrategy_cancel"
                id="btn_addStrategy_cancel" style="margin-left:120px;">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_addStrategy_commit"
                id="btn_addStrategy_commit">提交</button>
            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="btn_editStrategy_cancel"
                id="btn_editStrategy_cancel" style="margin-left:120px;">取消</button>
            <button class="layui-btn" lay-submit lay-filter="btn_editStrategy_commit"
                id="btn_editStrategy_commit">提交</button>
        </div>
    </div>
</form>

<body>
    <script src="./layui/layui.js"></script>
    <script>
        var layer = null, form = null, ele = null, table = null, laypage = null, laydate = null;
        var table_userList = null;
        var maxUserListLineCount = 15;
        var table_userListCurrentPageID = 1;//用户列表的当前页， 注意这里不要用索引
        var roleInfoMap = {};
        var autoInfoMap = {};
        var userCount = 0;//总用户数
        var userlistInfo = null;
        var userSelectPoint = 0;//用户数据起始查询点

        var table_conditionList = null;
        var maxConditionListLineCount = 15;
        var table_conditionListCurrentPageID = 1;//条件列表的当前页码 注意这里不要用索引
        var conditionTypeInfoMap = {};//条件信息字典
        var conditionMap = {};//条件数组的条件ID与数组索引的映射表
        var conditionArr = [];//条件信息数组
        var conditionCount = 0;//总条件数
        var conditionSelectPoint = 0;//条件信息数据的分页起始查询点

        var staticResourceDomain = "http://localhost:8080/"
        var strategyCategroyMap = {};//策略类别字典
        var strategyCategroyTemplateMap = {};//策略类别的模板存储字典
        var strategyMap = {};//策略信息字典
        var strategyContentMap = {};
        //一般直接写在一个js文件中
        layui.use(['layer', 'form', 'element', 'table', 'laypage', 'laydate'], function () {
            layer = layui.layer
            form = layui.form
            ele = layui.element
            table = layui.table
            laypage = layui.laypage;
            laydate = layui.laydate;

            laydate.render({
                elem: '#tb_add_SDate' //指定元素
                , type: 'datetime'
            });
            //自定义正则验证
            form.verify({
                pwdreg: [
                    /^[\S]{6,12}$/
                    , '密码必须6到12位，且不能出现空格'
                ],
                qujianNumber: function (value, item) {
                    let v = parseFloat(value);
                    let mi = item.min || 0;
                    let ma = item.max || 10000000000;
                    if (isNaN(v)) {
                        return "请输入指定范围内的数字"
                    } else if (v < mi || v > ma) {
                        return "数值超出范围:" + mi + " - " + ma;
                    }
                }
            });
            //添加 新增条件类型和新增条件的处理
            bindAddConditionAboutEvent(form, layer, laypage)
            bindAddUserEvent(form, layer, laypage);//绑定"添加用户"的相关事件
            bindStrategyEvent(form, layer, laypage);//绑定 决策相关 的处理事件
            //添加tab的相关处理
            ele.on('tab(mainTab)', function (data) {
                let index = data.index;
                if (index == 0) {
                    //添加用户管理列表table
                    table_userList = makeUserManagerList(table, layer, form, laypage);
                    //创建翻页工具条
                    laypage.render({
                        elem: 'limitBottomBar' //注意，这里的 testlaypage1 是 ID，不用加 # 号
                        , count: 50 //数据总数，从服务端得到
                    });
                    //获取权限信息列表
                    getAllAuth((data, err) => {
                        if (data != null) {
                            if (data.code == "0") {
                                autoInfoMap = {}
                                data.data.forEach((v, i) => {
                                    autoInfoMap[v.id] = v;
                                });//赋值权限列表
                                //获取权限列表
                                getAllRoleType((data, err) => {
                                    if (data != null) {
                                        if (data.code == "0") {
                                            roleInfoMap = {}
                                            data.data.forEach((v, i) => {
                                                roleInfoMap[v.id] = v;
                                            });//赋值角色列表

                                            //获取用户列表，并填充分页工具条
                                            fillUserList(laypage);
                                        } else {
                                            console.error(data.msg);
                                        }
                                    } else {
                                        console.error(err);
                                    }
                                })
                            } else {
                                console.error(data.msg)
                            }
                        } else {
                            console.error(err);
                        }
                    })

                } else if (index == 1) {
                    //添加策略管理table
                    table_conditionList = makeConditionListTable(table, layer, form, laypage);
                    //获取条件类型信息
                    getAllConditionTypeInfo((data, err) => {
                        if (data != null) {
                            if (data.code == "0") {
                                conditionTypeInfoMap = {};
                                let arr = data.data;
                                arr.forEach((v, i) => {
                                    conditionTypeInfoMap[v.id] = v
                                })

                                //填充条件列表
                                fillConditionList(laypage)
                            } else {
                                console.error(data.msg);
                            }
                        } else {
                            console.error(err);
                        }
                    })
                } else if (index == 2) {
                    //获取条件类型信息
                    getAllConditionTypeInfo((data, err) => {
                        if (data != null) {
                            if (data.code == "0") {
                                conditionTypeInfoMap = {};
                                let arr = data.data;
                                arr.forEach((v, i) => {
                                    conditionTypeInfoMap[v.id] = v
                                })
                                //获取所有的条件信息
                                getAllConditionInfo(0, 100000, (data, err) => {
                                    if (data != null) {
                                        if (data.code == "0") {
                                            conditionArr = makeConditionInfo(data.data);
                                        } else {
                                            console.error(err)
                                        }
                                    } else {
                                        console.error(err)
                                    }
                                })
                            } else {
                                console.error(data.msg);
                            }
                        } else {
                            console.error(err);
                        }
                    })

                    //调用“获取全部策略接口”
                    getAllStrategyCategroy((data, err) => {
                        if (data != null) {
                            if (data.code == "0") {
                                //填充strategyCategroyMap
                                strategyCategroyMap = {};
                                let arr = data.data;
                                arr.forEach((v, i) => {
                                    let sc = {};
                                    sc.name = v.name;
                                    sc.id = v.id;
                                    sc.des = v.des;
                                    sc.baseTemplatePath = v.baseTemplatePath;
                                    strategyCategroyMap[sc.id] = sc;
                                    loadStrategyCategroyContent(sc.baseTemplatePath);//加载模板内容
                                })
                                fillStrategyCategroyList();
                            } else {
                                console.error(data.msg);
                            }
                        } else {
                            console.error(err)
                        }
                    })
                }
            })
            ele.tabChange('mainTab', 'mUser');//默认选择第一选项"用户管理"
        });

        /**
         * 加载策略内容信息path
        */
        function loadStrategyContent(path) {
            $.ajax({
                url: path.replace("./", staticResourceDomain),
                data: {
                    t: new Date().valueOf()
                },
                dataType: "json",
                method: "GET",
                success: function (data) {
                    if (data) {
                        strategyContentMap[path] = data;//填充策略类型模板字典
                    }
                },
                error: function (err) {
                    console.error(err);
                }
            })
        }

        /**
         * 加载策略类型模板
        */
        function loadStrategyCategroyContent(path) {
            $.ajax({
                url: path.replace("./", staticResourceDomain),
                data: {
                    t: new Date().valueOf()
                },
                dataType: "json",
                method: "GET",
                success: function (data) {
                    if (data) {
                        strategyCategroyTemplateMap[path] = data;//填充策略类型模板字典
                    }
                },
                error: function (err) {
                    console.error(err);
                }
            })
        }

        function fillUserList(laypage) {
            //获取用户总数
            getUserCount((data, err) => {
                if (data != null) {
                    if (data.code == "0") {
                        userCount = parseInt(data.msg);
                        //重新填充分页工具条
                        laypage.render({
                            elem: 'limitBottomBar' //注意，这里的 testlaypage1 是 ID，不用加 # 号
                            , count: userCount //数据总数，从服务端得到
                            , limit: maxUserListLineCount//每页显示maxUserListLineCount条数据
                            , curr: table_userListCurrentPageID//当前页码
                            , jump: function (pageobj, first) {
                                userSelectPoint = (table_userListCurrentPageID - 1) * maxUserListLineCount;//重新计算用于查询数据的起始位置
                                //页面ID更改的监听处理
                                //首次不执行
                                if (!first) {
                                    //do something
                                    //换页操作
                                    table_userListCurrentPageID = pageobj.curr;//设置当前页
                                    userSelectPoint = (table_userListCurrentPageID - 1) * maxUserListLineCount;//重新计算用于查询数据的起始位置
                                    fillUserList(laypage)
                                } else {
                                    //首次初始化，不做任何操作,避免无限调用fillUserList
                                }
                            }
                        });
                        //分页获取用户信息
                        getAllUsers(userSelectPoint, maxUserListLineCount, (data, err) => {
                            if (data != null) {
                                if (data.code == "0") {
                                    userlistInfo = makeUserInfo(data.data);
                                    table_userList.reload({
                                        data: userlistInfo
                                    })
                                } else {
                                    console.error(data.msg);
                                }
                            } else {
                                console.error(err)
                            }
                        })
                    } else {
                        console.error(data.msg)
                    }
                } else {
                    console.error(err)
                }
            })
        }

        /**
         * 创建用户管理列表
        */
        function makeUserManagerList(table, layer, form, laypage) {
            let temp_table = table.render({
                elem: "#table_userList",
                loading: false,
                title: "用户列表",
                skin: "nob",
                even: "true",
                size: "sm",
                width: 786,
                limit: maxUserListLineCount,
                cols: [
                    [
                        { field: 'signName', title: '用户名', width: 160, sort: false, fixed: 'left', align: 'center', unresize: true },
                        { field: 'signPWD', title: '密码', width: 160, sort: false, fixed: 'left', align: 'center', unresize: true },
                        { field: 'roleName', title: '角色', width: 160, sort: false, fixed: 'left', align: 'center', unresize: true },
                        { width: 300, title: '操作', fixed: 'left', align: 'center', toolbar: '#table_userlist_barDemo', unresize: true }
                    ]
                ],
                done: function (res, curr, count) {
                    //如果是异步请求数据方式，res即为你接口返回的信息。
                    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度

                }
            })
            //添加工具条的监听事件
            table.on("tool(lay_table_userList)", function (obj) {
                let userData = obj.data;
                let evtType = obj.event;
                switch (evtType) {
                    case "roleinfo_des":
                        //查看角色详细描述
                        let str = "";
                        userData.authDesGroup.forEach((v, i) => {
                            str += "</br>" + v
                        })
                        layer.open({
                            title: '拥有的的权限',
                            type: 0,
                            content: str,
                            resize: false
                        });
                        break;
                    case "edit_userinfo":
                        //编辑用户信息
                        showEditUserPanel(form, layer, userData, laypage);
                        break;
                    case "delete_userinfo":
                        //删除用户信息
                        layer.open({
                            title: "删除用户",
                            content: "确定要删除用户(" + userData.signName + ")吗？",
                            area: ["300px", "200px"],
                            resize: false,
                            btn: ["确定", "取消"],
                            yes: (index, obj) => {
                                //确定操作
                                deleteUser(userData.uid, (data, err) => {
                                    if (data != null) {
                                        layer.alert(data.msg);
                                        if (data.code == "0") {
                                            //分页获取用户信息
                                            if ((userlistInfo || []).length == 1) {
                                                //如果删除的数据是本页的最后一条，则跳转至上一页
                                                table_userListCurrentPageID -= 1
                                            }
                                            fillUserList(laypage);
                                        }
                                    } else {
                                        console.error(err)
                                    }
                                })
                            },
                            btn2: (index, obj) => {
                                //取消操作,不用谢任何代码，即可默认关闭layer
                            },
                            btnAlign: "c"/*居中对齐*/
                        })
                        break;
                    default: break;
                }
            })
            return temp_table;
        }

        //显示用户信息编辑面板
        function showEditUserPanel(form, layer, userData, laypage) {
            let addUser_commit = document.getElementById("addUser_commit");
            addUser_commit.style.display = "none";
            let addUser_cancel = document.getElementById("addUser_cancel");
            addUser_cancel.style.display = "none";
            let editUser_cancel = document.getElementById("editUser_cancel");
            editUser_cancel.style.display = "inline-block";
            let editUser_commit = document.getElementById("editUser_commit");
            editUser_commit.style.display = "inline-block";
            form.on("submit(editUser_commit)", function (reqData) {
                //提交用户修改后的数据
                let uname = tb_edit_name.value;
                let upwd = tb_edit_pwd.value;
                let rid = rolelist.value;
                layer.close(openidx);//关闭弹窗
                updateUserInfo(userData.uid, uname, upwd, rid, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("更新用户信息成功")
                            //更新页面显示
                            //分页获取用户信息
                            fillUserList(laypage)
                        } else {
                            layer.alert("跟新用户信息失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("更新用户信息失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(editUser_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //填充内容
            let tb_edit_name = document.getElementById("tb_edit_name");
            let tb_edit_pwd = document.getElementById("tb_edit_pwd");
            let tb_edit_rolelist = document.getElementById("rolelist")
            tb_edit_rolelist.innerText = "";
            tb_edit_name.value = userData.signName;
            tb_edit_pwd.value = userData.signPWD;
            for (let rKey in roleInfoMap) {
                let option = document.createElement("option");
                if (rKey == userData.roleID)
                    option.selected = true;//设置默认选中
                option.setAttribute("value", rKey);
                option.appendChild(document.createTextNode(roleInfoMap[rKey].roleName));
                tb_edit_rolelist.appendChild(option);
            }
            form.render(null, "panel_editUserinfo");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "编辑用户信息",
                type: 1,
                area: ['390px', '350px'],
                content: $('#panel_editUserinfo'),
                resize: false
            });
        }

        /**
         * 组装用户信息
         * 
        */
        function makeUserInfo(sourceUserInfo) {
            let arr = [];
            sourceUserInfo.forEach((item, i) => {
                let user = {};
                user.uid = item.id;
                user.roleID = item.roleID;
                user.signName = item.signName;
                user.signPWD = item.signPWD;
                role = roleInfoMap[user.roleID];
                if (role) {
                    user.roleDes = role.roleDes;
                    user.roleName = role.roleName;
                    user.authDesGroup = [];
                    role.authGroup.split(",").forEach((authid, ai) => {
                        let auth = autoInfoMap[authid]
                        if (auth)
                            user.authDesGroup.push(auth.authDes);
                    })
                }
                arr.push(user);
            })
            return arr;
        }

        /**
         * 绑定策略相关的处理事件
        */
        function bindStrategyEvent(form, layer, laypage) {
            form.on("submit(btn_add_strategycategroy)", function (reqData) {
                showAddStrategyCategroyPanel(form, layer, laypage);//显示添加策略类别面板
                return false;
            });

            form.on("submit(btn_forceUseage)", function (reqData) {
                let sender = reqData.elem;
                let strategyId = sender.getAttribute("sid") || "-1";
                strategyId = parseInt(strategyId);
                if (isNaN(strategyId) == false && strategyId > -1) {
                    forceStrategyBeUseage(strategyId, function (data, err) {
                        if (data != null) {
                            if (data.code == "0") {
                                layer.alert(data.msg);
                            } else {
                                console.error(data.msg);
                            }
                        } else {
                            console.error(err);
                        }
                    })
                }
                return false;
            });
        }

        /**
         * 
         * 绑定""新增用户"相关的功能
        */
        function bindAddUserEvent(form, layer, laypage) {
            //清空原有表单的内容
            let tb_edit_name = document.getElementById("tb_edit_name");
            let tb_edit_pwd = document.getElementById("tb_edit_pwd");
            let tb_edit_rolelist = document.getElementById("rolelist");
            let openidx = -1;
            form.on("submit(addUser_commit)", function (reqData) {
                let uname = tb_edit_name.value;
                let upwd = tb_edit_pwd.value;
                let rid = rolelist.value;
                layer.close(openidx);//关闭弹窗
                //调用新增用户接口
                addUser(uname, upwd, rid, function (data, err) {
                    if (data != null) {
                        layer.alert(data.msg);
                        if (data.code == "0") {
                            //更新用户列表
                            table_userListCurrentPageID = 1;//新增用户成功后，需要返回至首页
                            fillUserList(laypage);
                        } else {
                            console.error(data.msg);
                        }
                    } else {
                        console.error(err);
                    }
                })
                return false;
            });
            form.on("submit(addUser_cancel)", function (data) {
                layer.close(openidx);//关闭弹窗
                return false;
            })
            form.on("submit(addUser_show)", function (data) {
                let addUser_commit = document.getElementById("addUser_commit");
                addUser_commit.style.display = "inline-block";
                let addUser_cancel = document.getElementById("addUser_cancel");
                addUser_cancel.style.display = "inline-block";
                let editUser_cancel = document.getElementById("editUser_cancel");
                editUser_cancel.style.display = "none";
                let editUser_commit = document.getElementById("editUser_commit");
                editUser_commit.style.display = "none";
                tb_edit_rolelist.innerText = "";
                tb_edit_name.value = "";
                tb_edit_pwd.value = "";
                for (let rKey in roleInfoMap) {
                    let option = document.createElement("option");
                    option.setAttribute("value", rKey);
                    option.appendChild(document.createTextNode(roleInfoMap[rKey].roleName));
                    tb_edit_rolelist.appendChild(option);
                }
                form.render(null, "panel_editUserinfo");//刷新表单的内容
                //弹出面板
                openidx = layer.open({
                    title: "新增用户信息",
                    type: 1,
                    area: ['390px', '350px'],
                    content: $('#panel_editUserinfo'),
                    resize: false
                });
                return false;
            })
        }

        /**
         * 创建条件信息列表
        */
        function makeConditionListTable(table, layer, form, laypage) {
            let temp_table = table.render({
                elem: "#table_conditionList",
                loading: false,
                title: "条件列表",
                skin: "nob",
                even: "true",
                size: "sm",
                width: 810,
                limit: maxConditionListLineCount,
                cols: [
                    [
                        {
                            field: 'conditionTypeName', title: '条件类型', width: 200, sort: false, fixed: 'left', align: 'center', unresize: true, templet: function (d) {
                                return '<span>' + d.zhName + "(" + d.enName + ")" + '</span>' + '<button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-filter="conditionItemShowTypeDes" id="cTypeitem_' + d.id + '" cid="' + d.id + '" lay-submit style="border:none;background:none;height:20px;line-height:20px;padding-left:4px;"><i class="layui-icon layui-icon-about"></i></button></span>'
                            }
                        },
                        {
                            field: 'name', title: '条件名称', width: 160, sort: false, fixed: 'left', align: 'center', unresize: true, templet: function (d) {
                                return d.name + '<button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-filter="conditionItemShowDes" id="citem_' + d.id + '" cid="' + d.id + '" lay-submit style="border:none;background:none;height:20px;line-height:20px;padding-left:4px;"><i class="layui-icon layui-icon-about"></i></button></span>'
                            }
                        },
                        { field: 'value', title: '条件值', width: 100, sort: false, fixed: 'left', align: 'center', unresize: true },
                        {
                            field: 'probability', title: '生效几率', width: 100, sort: false, fixed: 'left', align: 'center', unresize: true, templet: function (d) {
                                return '<span>' + (d.probability * 100).toFixed(2) + '%</span>'
                            }
                        },
                        { width: 240, title: '操作', fixed: 'left', align: 'center', toolbar: '#table_condition_bar', unresize: true }
                    ]
                ]
            })
            //添加工具条的监听事件
            table.on("tool(table_conditionList)", function (obj) {
                let conditionData = obj.data;
                let evtType = obj.event;
                switch (evtType) {
                    case "btn_edit_condition":
                        //编辑条件信息
                        showEditConditionPanel(form, layer, conditionData, laypage);
                        break;
                    case "btn_delete_condition":
                        //删除条件信息
                        layer.open({
                            title: "删除条件",
                            content: "确定要删除条件(" + conditionData.name + ")吗？",
                            area: ["300px", "200px"],
                            resize: false,
                            btn: ["确定", "取消"],
                            yes: (index, obj) => {
                                deleteCondition(conditionData.id, (data, err) => {
                                    if (data != null) {
                                        layer.alert(data.msg);
                                        if (data.code == "0") {
                                            //分页获取条件信息
                                            if ((conditionArr || []).length == 1) {
                                                //如果删除的数据是本页的最后一条，则跳转至上一页
                                                table_conditionListCurrentPageID -= 1
                                            }
                                            fillConditionList(laypage);
                                        }
                                    } else {
                                        console.error(err)
                                    }
                                })
                            },
                            btn2: (index, obj) => {
                                //取消操作,不用谢任何代码，即可默认关闭layer
                            },
                            btnAlign: "c"/*居中对齐*/
                        })
                        break;
                    default: break;
                }
            })
            return temp_table;
        }

        /**
         * 添加 新增条件类型和新增条件的处理
        */
        function bindAddConditionAboutEvent(form, layer, laypage) {
            form.on("submit(btn_showAddConditionTypePanel)", (btnData) => {
                showAddConditionTypePanel(form, layer, laypage);
            });
            form.on("submit(btn_showAddConditionPanel)", (btnData) => {
                showAddConditionPanel(form, layer, laypage)
            })
            form.on("submit(conditionItemShowDes)", (btnData) => {
                let cid = ((btnData.elem.attributes || {}).cid || {}).nodeValue;
                if (!!cid) {
                    cid = parseInt(cid);
                    let o = conditionMap[cid];
                    if (o) {
                        layer.tips(o.des == "" ? "无" : o.des, "#" + btnData.elem.id, {
                            tips: 3
                        })
                    }
                }
            })
            form.on("submit(conditionItemShowTypeDes)", (btnData) => {
                let cid = ((btnData.elem.attributes || {}).cid || {}).nodeValue;
                if (!!cid) {
                    cid = parseInt(cid);
                    let o = conditionMap[cid];
                    if (o) {
                        layer.tips(o.typeDes == "" ? "无" : o.typeDes, "#" + btnData.elem.id, {
                            tips: 3
                        })
                    }
                }
            })
        }

        /**
         * 填充条件列表
         * 
        */
        function fillConditionList(laypage) {
            //获取条件总数
            getConditionCount((data, err) => {
                if (data != null) {
                    if (data.code == "0") {
                        conditionCount = parseInt(data.msg);
                        //重新填充条件列表的分页工具条
                        laypage.render({
                            elem: 'conditionList_limitBottomBar' //注意，这里的 testlaypage1 是 ID，不用加 # 号
                            , count: conditionCount //数据总数，从服务端得到
                            , limit: maxConditionListLineCount//每页显示maxConditionListLineCount条数据
                            , curr: table_conditionListCurrentPageID//当前页码
                            , jump: function (pageobj, first) {
                                conditionSelectPoint = (table_conditionListCurrentPageID - 1) * maxConditionListLineCount;//重新计算用于查询数据的起始位置
                                //页面ID更改的监听处理
                                //首次不执行
                                if (!first) {
                                    //do something
                                    //换页操作
                                    table_conditionListCurrentPageID = pageobj.curr;//设置当前页
                                    conditionSelectPoint = (table_conditionListCurrentPageID - 1) * maxConditionListLineCount;//重新计算用于查询数据的起始位置
                                    fillConditionList(laypage)
                                } else {
                                    //首次初始化，不做任何操作,避免无限调用fillUserList
                                }
                            }
                        });
                        // //分页获取条件信息
                        getAllConditionInfo(conditionSelectPoint, maxConditionListLineCount, (data, err) => {
                            if (data != null) {
                                if (data.code == "0") {
                                    conditionArr = makeConditionInfo(data.data);
                                    table_conditionList.reload({
                                        data: conditionArr
                                    })
                                } else {
                                    console.error(err)
                                }
                            } else {
                                console.error(err)
                            }
                        })
                    } else {
                        console.error(data.msg);
                    }
                } else {
                    console.error(err)
                }
            })
        }
        function makeConditionInfo(dataArr) {
            let resultArr = [];
            conditionMap = {};
            dataArr.forEach((v, i) => {
                let item = {};
                item.des = v.des;
                item.id = v.id;
                item.name = v.name;
                item.probability = v.probability;
                item.value = v.value;
                item.typeID = v.typeID;
                let typeItem = conditionTypeInfoMap[v.typeID] || {};
                item.zhName = typeItem["zhName"] || "";
                item.enName = typeItem["enName"] || "";
                item.typeDes = typeItem["des"];
                resultArr.push(item);
                conditionMap[item.id] = item;
            })
            return resultArr;
        }

        //显示条件信息编辑面板
        function showEditConditionPanel(form, layer, conditionData, laypage) {
            //显示业务相关的按钮
            let btn_addCondition_commit = document.getElementById("btn_addCondition_commit");
            btn_addCondition_commit.style.display = "none";
            let btn_addCondition_cancel = document.getElementById("btn_addCondition_cancel");
            btn_addCondition_cancel.style.display = "none";
            let btn_editCondition_commit = document.getElementById("btn_editCondition_commit");
            btn_editCondition_commit.style.display = "inline-block";
            let btn_editCondition_cancel = document.getElementById("btn_editCondition_cancel");
            btn_editCondition_cancel.style.display = "inline-block";
            //获取界面操作元素
            let cTypelist = document.getElementById("cTypelist");
            let tb_add_conditionName = document.getElementById("tb_add_conditionName");
            let tb_add_conditionValue = document.getElementById("tb_add_conditionValue");
            let tb_add_condition_des = document.getElementById("tb_add_condition_des");
            let tb_add_probability = document.getElementById("tb_add_probability");

            form.on("submit(btn_editCondition_commit)", function (reqData) {
                //提交用户修改后的数据
                let cName = tb_add_conditionName.value;
                let cValue = tb_add_conditionValue.value;
                let cDes = tb_add_condition_des.value;
                let tmpProbility = parseFloat(tb_add_probability.value);
                tmpProbility = tmpProbility < 0 ? 0 : tmpProbility;
                tmpProbility = tmpProbility > 1 ? 1 : tmpProbility;
                let cProbility = tmpProbility;
                let cTypeID = cTypelist.value;
                layer.close(openidx);//关闭弹窗
                updateConditionInfo(cTypeID, cName, cValue, cProbility, cDes, conditionData.id, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("更新条件信息成功")
                            //更新页面显示
                            //分页获取用户信息
                            fillConditionList(laypage)
                        } else {
                            layer.alert("更新条件信息失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("更新条件信息失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_editCondition_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //重新填充内容
            cTypelist.innerText = "";
            tb_add_conditionName.value = conditionData.name;
            tb_add_conditionValue.value = conditionData.value;
            tb_add_condition_des.value = conditionData.des;
            tb_add_probability.value = conditionData.probability;
            let cTypeObj = null;
            for (let cKey in conditionTypeInfoMap) {
                let option = document.createElement("option");
                if (cKey == conditionData.typeID)
                    option.selected = true;//设置默认选中
                option.setAttribute("value", cKey);
                cTypeObj = conditionTypeInfoMap[cKey]
                option.appendChild(document.createTextNode(cTypeObj.enName + "(" + cTypeObj.zhName + ")"));
                cTypelist.appendChild(option);
            }
            form.render(null, "panel_addCondition");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "编辑条件信息",
                type: 1,
                area: ['390px', '490px'],
                content: $('#panel_addCondition'),
                resize: false
            });
        }

        //显示新增条件信息面板
        function showAddConditionPanel(form, layer, laypage) {
            //显示业务相关的按钮
            let btn_addCondition_commit = document.getElementById("btn_addCondition_commit");
            btn_addCondition_commit.style.display = "inline-block";
            let btn_addCondition_cancel = document.getElementById("btn_addCondition_cancel");
            btn_addCondition_cancel.style.display = "inline-block";
            let btn_editCondition_commit = document.getElementById("btn_editCondition_commit");
            btn_editCondition_commit.style.display = "none";
            let btn_editCondition_cancel = document.getElementById("btn_editCondition_cancel");
            btn_editCondition_cancel.style.display = "none";
            //获取界面操作元素
            let cTypelist = document.getElementById("cTypelist");
            let tb_add_conditionName = document.getElementById("tb_add_conditionName");
            let tb_add_conditionValue = document.getElementById("tb_add_conditionValue");
            let tb_add_condition_des = document.getElementById("tb_add_condition_des");
            let tb_add_probability = document.getElementById("tb_add_probability");

            form.on("submit(btn_addCondition_commit)", function (reqData) {
                //提交用户修改后的数据
                let cName = tb_add_conditionName.value;
                let cValue = tb_add_conditionValue.value;
                let cDes = tb_add_condition_des.value;
                let tmpProbility = parseFloat(tb_add_probability.value);
                tmpProbility = tmpProbility < 0 ? 0 : tmpProbility;
                tmpProbility = tmpProbility > 1 ? 1 : tmpProbility;
                let cProbility = tmpProbility;
                let cTypeID = cTypelist.value;
                layer.close(openidx);//关闭弹窗
                addCondition(cTypeID, cName, cValue, cProbility, cDes, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("新增条件信息成功")
                            //更新页面显示
                            table_conditionListCurrentPageID = 1;//回到条件列表首页
                            //分页获取用户信息
                            fillConditionList(laypage)
                        } else {
                            layer.alert("新增条件信息失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("新增条件信息失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_addCondition_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //重新填充内容
            cTypelist.innerText = "";
            tb_add_conditionName.value = "";
            tb_add_conditionValue.value = "";
            tb_add_condition_des.value = "";
            tb_add_probability.value = "1";
            let cTypeObj = null;
            for (let cKey in conditionTypeInfoMap) {
                let option = document.createElement("option");
                option.setAttribute("value", cKey);
                cTypeObj = conditionTypeInfoMap[cKey]
                option.appendChild(document.createTextNode(cTypeObj.enName + "(" + cTypeObj.zhName + ")"));
                cTypelist.appendChild(option);
            }
            form.render(null, "panel_addCondition");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "新增条件信息",
                type: 1,
                area: ['390px', '490px'],
                content: $('#panel_addCondition'),
                resize: false
            });
        }

        /**
         * 显示 新增条件类型信息面板
        */
        function showAddConditionTypePanel(form, layer, laypage) {
            //获取界面操作元素
            let tb_add_conditionType_zh = document.getElementById("tb_add_conditionType_zh");
            let tb_add_conditionType_en = document.getElementById("tb_add_conditionType_en");
            let tb_add_conditionType_des = document.getElementById("tb_add_conditionType_des");

            form.on("submit(btn_addConditionType_commit)", function (reqData) {
                //提交用户修改后的数据
                let zhName = tb_add_conditionType_zh.value;
                let enName = tb_add_conditionType_en.value;
                let des = tb_add_conditionType_des.value;
                layer.close(openidx);//关闭弹窗
                addConditionType(zhName, enName, des, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("新增条件类型成功")
                            //更新条件类型数组
                            getAllConditionTypeInfo((data, err) => {
                                if (data != null) {
                                    if (data.code == "0") {
                                        conditionTypeInfoMap = {};
                                        let arr = data.data;
                                        arr.forEach((v, i) => {
                                            conditionTypeInfoMap[v.id] = v
                                        })
                                    } else {
                                        console.error(data.msg);
                                    }
                                } else {
                                    console.error(err);
                                }
                            })
                        } else {
                            layer.alert("新增条件类型失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("新增条件类型失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_addConditionType_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //重新填充内容
            tb_add_conditionType_zh.value = "";
            tb_add_conditionType_en.value = "";
            tb_add_conditionType_des.value = "";
            form.render(null, "panel_addConditionType");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "新增条件类型",
                type: 1,
                area: ['370px', '370px'],
                content: $('#panel_addConditionType'),
                resize: false
            });
        }

        /**
         * 当策略类别toolbar上的按钮被点击时的处理
         * 
        */
        function onStrategyTitleBar_btn_Click(sender) {
            let execType = sender.getAttribute("execType")
            let sid = sender.getAttribute("sid")
            let tmpId = "";
            switch (execType) {
                case "zhedie":
                    tmpId = "strategyContentList_" + sid;
                    document.getElementById(tmpId).style.display = "block";
                    sender.innerHTML = "&#xe63d;";
                    sender.setAttribute("execType", "");
                    //调用“获取全部策略接口”
                    getStrategyByStrategyCategroyID(sid, (data, err) => {
                        sender.innerHTML = "&#xe619;";
                        sender.setAttribute("execType", "zhankai");
                        if (data != null) {
                            if (data.code == "0") {
                                let arr = data.data;
                                arr.forEach((v, i) => {
                                    //增量更新
                                    let sItem = {};
                                    sItem.conditionGroup = v.conditionGroup;
                                    sItem.enabled = v.enabled;
                                    sItem.expireDate = v.expireDate;
                                    sItem.id = v.id;
                                    sItem.name = v.name;
                                    sItem.sid = v.sid;
                                    sItem.valuePath = v.valuePath;
                                    strategyMap[sItem.id] = sItem;
                                    if (!!strategyContentMap[sItem.valuePath] == false)
                                        loadStrategyContent(sItem.valuePath);//加载策略内容
                                })
                                //更新显示列表
                                fillStrategyList(sid);
                            } else {
                                console.error(data.msg);
                            }
                        } else {
                            console.error(err)
                        }
                    })
                    break;
                case "zhankai":
                    tmpId = "strategyContentList_" + sid;
                    document.getElementById(tmpId).style.display = "none";
                    sender.innerHTML = "&#xe61a;";
                    sender.setAttribute("execType", "zhedie");
                    break;
                case "edit":
                    showEditStrategyCategroyPanel(sid);//
                    break;
                case "des":
                    layer.tips(strategyCategroyMap[sid] ? strategyCategroyMap[sid].des : "无", '#' + sender.id, {
                        tips: 2
                    });
                    break;
                case "delete":
                    deleteSC(sid);
                    break;
                case "add":
                    showAddStrategyPanel(sid)
                    break;
            }
        }

        /**
         * 
         * 当策略item上的按钮被点击
        */
        function onStrategyItem_btn_Click(sender) {
            let type = sender.getAttribute("execType")
            let strategyId = parseInt(sender.getAttribute("sid"));
            let strategyInfo = strategyMap[strategyId];
            if (strategyInfo) {
                switch (type) {
                    case "editStrategy":
                        showEditStrategyPanel(strategyInfo.sid,strategyInfo,strategyContentMap[strategyInfo.valuePath]);
                        break;
                }
            }else{
                layui.alert("未找到对应的策略信息")
            }
        }

        /**
         * 显示添加策略类别 的面板
        */
        function showAddStrategyCategroyPanel(form, layer, laypage) {
            let btn_editSC_cancel = document.getElementById("btn_editSC_cancel");
            btn_editSC_cancel.style.display = "none";
            let btn_editSC_commit = document.getElementById("btn_editSC_commit");
            btn_editSC_commit.style.display = "none";
            let btn_addSC_cancel = document.getElementById("btn_addSC_cancel");
            btn_addSC_cancel.style.display = "inline-block";
            let btn_addSC_commit = document.getElementById("btn_addSC_commit");
            btn_addSC_commit.style.display = "inline-block";
            form.on("submit(btn_addSC_commit)", function (reqData) {
                //新增 策略类型
                let sname = tb_add_scName.value;
                let templateContent = tb_add_sc_template.value;
                let jsonObj = JSON.parse(templateContent);
                if (!jsonObj) {
                    layer.alert("templateContent转json失败，请检查templateContent");
                    return false;
                }
                let scDes = tb_add_sc_des.value;
                layer.close(openidx);//关闭弹窗
                addStrategyCategroy(sname, scDes, templateContent, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("新增策略类别成功")
                            //更新页面显示
                            //调用“获取全部策略接口”
                            getAllStrategyCategroy((data, err) => {
                                if (data != null) {
                                    if (data.code == "0") {
                                        let arr = data.data;
                                        arr.forEach((v, i) => {
                                            //增量更新
                                            if (!strategyCategroyMap[v.id]) {
                                                let sc = {};
                                                sc.name = v.name;
                                                sc.id = v.id;
                                                sc.des = v.des;
                                                sc.baseTemplatePath = v.baseTemplatePath;
                                                strategyCategroyMap[sc.id] = sc;
                                                loadStrategyCategroyContent(sc.baseTemplatePath);//加载模板内容
                                            }
                                        })
                                        //更新显示列表
                                        fillStrategyCategroyList();
                                    } else {
                                        console.error(data.msg);
                                    }
                                } else {
                                    console.error(err)
                                }
                            })
                        } else {
                            layer.alert("新增策略类别失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("新增策略类别失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_addSC_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //填充内容
            let tb_add_scName = document.getElementById("tb_add_scName");
            let tb_add_sc_template = document.getElementById("tb_add_sc_template");
            let tb_add_sc_des = document.getElementById("tb_add_sc_des")
            tb_add_scName.value = "";
            tb_add_sc_template.value = "";
            tb_add_sc_des.value = "";
            form.render(null, "panel_addStrategyCategroy");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "新增策略类别信息",
                type: 1,
                area: ['590px', '550px'],
                content: $('#panel_addStrategyCategroy'),
                resize: false
            });
        }

        /**
         * 显示编辑策略类别 的面板
        */
        function showEditStrategyCategroyPanel(sid) {
            let btn_editSC_cancel = document.getElementById("btn_editSC_cancel");
            btn_editSC_cancel.style.display = "inline-block";
            let btn_editSC_commit = document.getElementById("btn_editSC_commit");
            btn_editSC_commit.style.display = "inline-block";
            let btn_addSC_cancel = document.getElementById("btn_addSC_cancel");
            btn_addSC_cancel.style.display = "none";
            let btn_addSC_commit = document.getElementById("btn_addSC_commit");
            btn_addSC_commit.style.display = "none";
            form.on("submit(btn_editSC_commit)", function (reqData) {
                //新增 策略类型
                let sname = tb_add_scName.value;
                let templateContent = tb_add_sc_template.value;
                let jsonObj = JSON.parse(templateContent);
                if (!jsonObj) {
                    layer.alert("templateContent转json失败，请检查templateContent");
                    return false;
                }
                let scDes = tb_add_sc_des.value;
                layer.close(openidx);//关闭弹窗
                updateStrategyCategroy(sname, scDes, templateContent, sid, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("更新策略类别成功")
                            //更新页面显示
                            //调用“获取全部策略接口”
                            getAllStrategyCategroy((data, err) => {
                                if (data != null) {
                                    if (data.code == "0") {
                                        //填充strategyCategroyMap
                                        let arr = data.data;
                                        arr.forEach((v, i) => {
                                            //增量更新
                                            if (v.id == sid) {
                                                let sc = {};
                                                sc.name = v.name;
                                                sc.id = v.id;
                                                sc.des = v.des;
                                                sc.baseTemplatePath = v.baseTemplatePath;
                                                strategyCategroyMap[sc.id] = sc;
                                                loadStrategyCategroyContent(sc.baseTemplatePath);//加载模板内容
                                            }
                                        })
                                        //更新显示列表
                                        fillStrategyCategroyList();
                                    } else {
                                        console.error(data.msg);
                                    }
                                } else {
                                    console.error(err)
                                }
                            })
                        } else {
                            layer.alert("更新策略类别失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("更新策略类别失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_editSC_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })
            let strategyCategroyInfo = strategyCategroyMap[sid];//获取类别信息
            if (!strategyCategroyInfo) {
                layer.alert("未获取到策略类别信息");
                return
            }
            //加载模板信息
            //填充内容
            let tb_add_scName = document.getElementById("tb_add_scName");
            let tb_add_sc_template = document.getElementById("tb_add_sc_template");
            let tb_add_sc_des = document.getElementById("tb_add_sc_des")
            tb_add_scName.value = strategyCategroyInfo.name;
            let tmpO = strategyCategroyTemplateMap[strategyCategroyInfo.baseTemplatePath]
            tb_add_sc_template.value = tmpO ? JSON.stringify(tmpO) : "";
            tb_add_sc_des.value = strategyCategroyInfo.des;
            form.render(null, "panel_addStrategyCategroy");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "编辑策略类别信息",
                type: 1,
                area: ['590px', '550px'],
                content: $('#panel_addStrategyCategroy'),
                resize: false
            });


        }
        /**
         * 填充 策略类别信息列表
        */
        function fillStrategyCategroyList(selectSid = -1) {
            let baseNode = document.getElementById("strategyCategroyContainer");
            //移除原有的
            while (baseNode.children.length > 0)
                baseNode.removeChild(baseNode.children[0]);
            //填充新的
            let titleNode = null, listNode = null, sid, name;
            for (k in strategyCategroyMap) {
                sid = k;
                name = strategyCategroyMap[k].name;
                titleNode = document.createElement("div");
                titleNode.setAttribute("id", "strategyTitleBar_" + sid)
                titleNode.setAttribute("class", "strategyTitleBar");
                titleNode.innerHTML = `<span>
                                <span class="strategyTitleBar_title">` + name + `</span>
                                <i id="strategyTitleBar_titleDes_`+ sid + `" class="layui-icon layui-icon-about"
                                    style="float: left;"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="des"
                                    sid="`+ sid + `"></i>
                                <i class="layui-icon" style="float: right;margin-right: 10px;"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" id="strategyTitleBar_titleIcon_`+ sid + `" execType="zhedie"
                                    sid="`+ sid + `">&#xe61a;</i>
                                <span class="strategyTitleBar_btn"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="edit"
                                    sid="`+ sid + `">编辑类别</span>
                                <span class="strategyTitleBar_btn"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="delete"
                                    sid="`+ sid + `">删除类别</span>
                                <span class="strategyTitleBar_btn"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="add"
                                    sid="`+ sid + `">新增策略</span>
                            </span>`
                listNode = document.createElement("div");
                listNode.setAttribute("id", "strategyContentList_" + sid);
                listNode.setAttribute("class", "strategyContentList");
                baseNode.appendChild(titleNode);//添加title
                baseNode.appendChild(listNode);//添加列表
            }

            if (selectSid > -1) {
                let selectedNode = document.getElementById("strategyTitleBar_titleIcon_" + selectSid)
                if (selectedNode) {
                    onStrategyTitleBar_btn_Click(selectedNode);//展开选中项
                }
            }
        }

        /**
         * 删除策略类别
         * 
        */
        function deleteSC(sid) {
            //删除用户信息
            layer.open({
                title: "删除策略类别",
                content: "确定要删除吗？",
                area: ["300px", "200px"],
                resize: false,
                btn: ["确定", "取消"],
                yes: (index, obj) => {
                    //确定操作
                    deleteStrategyCategroy(sid, (data, err) => {
                        if (data != null) {
                            layer.alert(data.msg);
                            if (data.code == "0") {
                                console.log("更新策略类型列表")
                                //更新数据集合
                                let path = strategyCategroyMap[sid].baseTemplatePath || "";
                                delete strategyCategroyMap[sid];
                                delete strategyCategroyTemplateMap[path];
                                //更新显示列表
                                fillStrategyCategroyList()
                            } else {
                                console.error(data.msg);
                            }
                        } else {
                            console.error(err)
                        }
                    })
                },
                btn2: (index, obj) => {
                    //取消操作,不用谢任何代码，即可默认关闭layer
                },
                btnAlign: "c"/*居中对齐*/
            })

        }

        /**
         * 显示新增策略面板
        */
        function showAddStrategyPanel(sid) {
            let strategyCategroyObj = strategyCategroyMap[sid] || {};
            let key = strategyCategroyObj["baseTemplatePath"] || "";
            let templateObj = strategyCategroyTemplateMap[key];
            if (templateObj) {
                makeAndRefillStrategyForm(templateObj);//重新填充表单的内容
            } else {
                layer.alert("策略模板正在加载中，请稍后重试");
                return;
            }
            let btn_editStrategy_cancel = document.getElementById("btn_editStrategy_cancel");
            btn_editStrategy_cancel.style.display = "none";
            let btn_editStrategy_commit = document.getElementById("btn_editStrategy_commit");
            btn_editStrategy_commit.style.display = "none";
            let btn_addStrategy_cancel = document.getElementById("btn_addStrategy_cancel");
            btn_addStrategy_cancel.style.display = "inline-block";
            let btn_addStrategy_commit = document.getElementById("btn_addStrategy_commit");
            btn_addStrategy_commit.style.display = "inline-block";
            form.on("submit(btn_addStrategy_commit)", function (reqData) {
                ////新增 策略类型
                let sName = tb_add_SName.value;
                let sDate = new Date(tb_add_SDate.value).valueOf();
                if (isNaN(sDate) == false)
                    sDate = sDate / 1000;
                let sIsEnabled = (!!tb_add_SEnabled.checked) ? 1 : 0;
                let reqContext = createStrategyContentByTemplateObj(templateObj);
                let strategyContext = JSON.stringify(reqContext);
                // console.log("sName=",sName,"sDate=",sDate,"sIsEnabled=",sIsEnabled,"sid=",sid)
                // console.log("reqContext=",reqContext)
                layer.close(openidx);//关闭弹窗
                addStrategy(sid, strategyContext, sDate, sIsEnabled, sName, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("新增策略成功")
                            //更新页面显示
                            let selectedNode = document.getElementById("strategyTitleBar_titleIcon_" + sid)
                            if (selectedNode) {
                                selectedNode.setAttribute("execType", "zhedie");
                                onStrategyTitleBar_btn_Click(selectedNode);//展开选中项
                            }
                        } else {
                            layer.alert("新增策略失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("新增策略失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_addStrategy_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //填充内容
            let tb_add_SName = document.getElementById("tb_add_SName");
            let tb_add_SDate = document.getElementById("tb_add_SDate");
            let tb_add_SEnabled = document.getElementById("tb_add_SEnabled")
            tb_add_SName.value = "";
            tb_add_SDate.value = "";
            tb_add_SEnabled.checked = false;
            form.render(null, "panel_addStrategy");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "新增策略信息",
                type: 1,
                area: '590px',
                content: $('#panel_addStrategy'),
                resize: false
            });
        }

        /**
         * 显示新增策略面板
        */
        function showEditStrategyPanel(sid, strategyInfo, strategyContent) {
            let strategyCategroyObj = strategyCategroyMap[sid] || {};
            let key = strategyCategroyObj["baseTemplatePath"] || "";
            let templateObj = strategyCategroyTemplateMap[key];
            if (templateObj && strategyContent) {
                reFillStrategyFormByTemplateObjAndStrategyContent(templateObj, strategyContent);//重新填充表单的内容
            } else {
                layer.alert("策略模板正在加载中，请稍后重试");
                return;
            }
            let btn_editStrategy_cancel = document.getElementById("btn_editStrategy_cancel");
            btn_editStrategy_cancel.style.display = "inline-block";
            let btn_editStrategy_commit = document.getElementById("btn_editStrategy_commit");
            btn_editStrategy_commit.style.display = "inline-block";
            let btn_addStrategy_cancel = document.getElementById("btn_addStrategy_cancel");
            btn_addStrategy_cancel.style.display = "none";
            let btn_addStrategy_commit = document.getElementById("btn_addStrategy_commit");
            btn_addStrategy_commit.style.display = "none";
            form.on("submit(btn_editStrategy_commit)", function (reqData) {
                //编辑策略信息
                let sName = tb_add_SName.value;
                let sDate = new Date(tb_add_SDate.value).valueOf();
                if (isNaN(sDate) == false)
                    sDate = sDate / 1000;
                let sIsEnabled = (!!tb_add_SEnabled.checked) ? 1 : 0;
                let reqContext = createStrategyContentByTemplateObj(templateObj);
                let strategyContext = JSON.stringify(reqContext);
                // console.log("sName=",sName,"sDate=",sDate,"sIsEnabled=",sIsEnabled,"sid=",sid)
                // console.log("reqContext=",reqContext)
                layer.close(openidx);//关闭弹窗
                updateStrategyInfo(strategyInfo.id, strategyContext, sDate, sIsEnabled, sName, (data, err) => {
                    if (data != null) {
                        if (data.code == "0") {
                            layer.alert("更新策略成功")
                            //更新页面显示
                            let selectedNode = document.getElementById("strategyTitleBar_titleIcon_" + sid)
                            if (selectedNode) {
                                selectedNode.setAttribute("execType", "zhedie");
                                onStrategyTitleBar_btn_Click(selectedNode);//展开选中项
                            }
                        } else {
                            layer.alert("更新策略失败")
                            console.error(data.msg);
                        }
                    } else {
                        layer.alert("更新策略失败")
                        console.error(err);
                    }
                })
                return false;//禁止由于提交表单造成的页面刷新
            })
            form.on("submit(btn_editStrategy_cancel)", function (reqData) {
                //取消修改
                layer.close(openidx);//关闭弹窗
                return false;//禁止由于提交表单造成的页面刷新
            })

            //填充内容
            let tb_add_SName = document.getElementById("tb_add_SName");
            let tb_add_SDate = document.getElementById("tb_add_SDate");
            let tb_add_SEnabled = document.getElementById("tb_add_SEnabled")
            tb_add_SName.value = strategyInfo.name;
            tb_add_SDate.value = makeDateTimeStr(new Date(strategyInfo.expireDate * 1000), "yyyy-MM-dd HH:mm:ss");
            tb_add_SEnabled.checked = (strategyInfo.enabled == 1);
            form.render(null, "panel_addStrategy");//刷新表单的内容

            //弹出面板
            let openidx = layer.open({
                title: "编辑信息",
                type: 1,
                area: '590px',
                content: $('#panel_addStrategy'),
                resize: false
            });
        }
        /**
         * 填充 策略信息列表
        */
        function fillStrategyList(selectSid) {
            let sid = parseInt(selectSid);
            let baseNode = document.getElementById("strategyContentList_" + selectSid);
            //移除原有的
            while (baseNode.children.length > 0)
                baseNode.removeChild(baseNode.children[0]);
            //填充新的
            let strategyItem = null, sgy = null, strategyItem_left = null, strategyItem_bottom = null, strategyItem_right = null, eDate = null;
            for (k in strategyMap) {
                sgy = strategyMap[k];
                if (sgy.sid == sid) {
                    eDate = new Date(sgy.expireDate * 1000);
                    strategyItem = document.createElement("div");
                    strategyItem.setAttribute("id", "strategyListItem_" + k)
                    strategyItem.setAttribute("class", "strategyListItem");
                    strategyItem_left = document.createElement("div");
                    strategyItem_left.setAttribute("class", "strategyListItem_left");
                    strategyItem_left.innerHTML = `<div>
                                        <label class="gml_label">策略名</label>
                                        <label class="gml_label_v">`+ sgy.name + `</label>
                                    </div>
                                    <div>
                                        <label class="gml_label">过期时间</label>
                                        <label class="gml_label_v">`+ makeDateTimeStr(eDate, "yyyy-MM-dd HH:mm:ss") + `</label>
                                    </div>
                                    <div>
                                        <label class="gml_label">是否启用</label>
                                        <label class="gml_label_v">`+ (sgy.enabled == 1 ? "使用中" : "已禁用") + `</label>
                                    </div>`
                    strategyItem_right = document.createElement("div");
                    strategyItem_right.setAttribute("class", "strategyListItem_right");
                    strategyItem_right.innerHTML = `<div class="strategyListItem_right_btn"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);"
                                        execType="editStrategy" sid="`+ sgy.id + `">编辑策略</div>
                                    <div class="strategyListItem_right_btn"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);"
                                        execType="editCondition" sid="`+ sgy.id + `">编辑条件</div>
                                    <div class="strategyListItem_right_btn_delete"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);" execType="delete"
                                        sid="`+ sgy.id + `">删除策略</div>
                                    <button class="layui-btn layui-btn-sm" style="float:right;margin:10px 20px;"
                                        lay-submit lay-filter="btn_forceUseage" id="btn_forceUseage"
                                        sid="`+ sgy.id + `">强制即时生效</button>`;
                    strategyItem_bottom = document.createElement("div");
                    strategyItem_bottom.setAttribute("class", "strategyListItem_bottom");
                    strategyItem.appendChild(strategyItem_left)
                    strategyItem.appendChild(strategyItem_right)
                    strategyItem.appendChild(strategyItem_bottom);
                    baseNode.appendChild(strategyItem);
                }

            }



        }



    </script>
    <div class="layui-tab layui-tab-brief" lay-filter="mainTab">
        <ul class="layui-tab-title">
            <li lay-id="mUser">用户管理</li>
            <li lay-id="mCondition">维护策略条件</li>
            <li lay-id="mStrategy">维护策略</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item">
                <button class="layui-btn layui-btn-sm" lay-submit lay-filter="addUser_show">添加管理员</button>
                <div id="table_userList" lay-filter="lay_table_userList"></div>
                <div id="limitBottomBar"></div>
            </div>
            <div class="layui-tab-item">
                <div class="layui-form-item">
                    <button class="layui-btn layui-btn-sm" lay-submit
                        lay-filter="btn_showAddConditionTypePanel">新增条件类型</button>
                    <button class="layui-btn layui-btn-sm" lay-submit
                        lay-filter="btn_showAddConditionPanel">新增条件</button>
                </div>
                <div id="table_conditionList" lay-filter="table_conditionList"></div>
                <div id="conditionList_limitBottomBar"></div>
            </div>
            <div class="layui-tab-item">
                <div>
                    <button class="layui-btn layui-btn-sm" lay-submit lay-filter="btn_add_strategycategroy"
                        id="btn_add_strategycategroy">新增策略类别</button>
                    <div id="strategyCategroyContainer">
                        <div class="strategyTitleBar">
                            <span>
                                <span class="strategyTitleBar_title">1对1教室策略</span>
                                <i id="strategyTitleBar_titleDes_0" class="layui-icon layui-icon-about"
                                    style="float: left;"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="des"
                                    sid="0"></i>
                                <i class="layui-icon" style="float: right;margin-right: 10px;"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="zhedie"
                                    sid="0">&#xe61a;</i>
                                <span class="strategyTitleBar_btn"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="edit"
                                    sid="0">编辑类别</span>
                                <span class="strategyTitleBar_btn"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="delete"
                                    sid="0">删除类别</span>
                                <span class="strategyTitleBar_btn"
                                    onclick="javascript:void(0);onStrategyTitleBar_btn_Click(this);" execType="add"
                                    sid="0">新增策略</span>
                            </span>
                        </div>
                        <div id="strategyContentList_0" class="strategyContentList">
                            <div id="strategyListItem_0" class="strategyListItem">
                                <div class="strategyListItem_left">
                                    <div>
                                        <label class="gml_label">策略名</label>
                                        <label class="gml_label_v">1v1牛逼策略</label>
                                    </div>
                                    <div>
                                        <label class="gml_label">过期时间</label>
                                        <label class="gml_label_v">2019-01-11 18:30:00</label>
                                    </div>
                                    <div>
                                        <div class="layui-form">
                                            <label class="gml_label" style="height:40px;line-height:40px;">是否启用</label>
                                            <div class="gml_label_v"><input type="checkbox" name="switch"
                                                    lay-skin="switch"></div>
                                            <div style="clear: both;"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="gml_label">匹配条件</label>
                                        <label class="gml_label_v">用户类型 = 学生 概率50.00%</label>
                                    </div>
                                    <div>
                                        <label class="gml_label"></label>
                                        <label class="gml_label_v">课程类型 = 1v1青少课 概率100.00%</label>
                                    </div>
                                    <div>
                                        <label class="gml_label"></label>
                                        <label class="gml_label_v">课程类型 = 1v1青少课 概率100.00%</label>
                                    </div>
                                    <div>
                                        <label class="gml_label"></label>
                                        <label class="gml_label_v">课程类型 = 1v1青少课 概率100.00%</label>
                                    </div>
                                </div>
                                <div class="strategyListItem_right">
                                    <div class="strategyListItem_right_btn"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);" execType="select"
                                        sid="0">预览策略</div>
                                    <div class="strategyListItem_right_btn"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);"
                                        execType="editStrategy" sid="0">编辑策略</div>
                                    <div class="strategyListItem_right_btn"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);"
                                        execType="editCondition" sid="0">编辑条件</div>
                                    <div class="strategyListItem_right_btn_delete"
                                        onclick="javascript:void(0);onStrategyItem_btn_Click(this);" execType="delete"
                                        sid="0">删除策略</div>
                                    <button class="layui-btn layui-btn-sm" style="float:right;margin:10px 20px;"
                                        lay-submit lay-filter="btn_forceUseage" id="btn_forceUseage"
                                        sid="0">强制即时生效</button>
                                </div>
                                <div class="strategyListItem_bottom"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

</body>

</html>