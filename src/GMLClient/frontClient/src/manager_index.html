<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>接口调用测试</title>
    <style type="text/css">
        body,html{
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
    </style>
    <script type="text/javascript" src="jq.js"></script>
    <script type="text/javascript" src="interfaceExec.js"></script>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <!-- 用户信息编辑的工具条 -->
    <script type="text/html" id="table_userlist_barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="roleinfo_des" id="roleinfo_des">权限详细</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit_userinfo" lay-filter="edit_userinfo">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete_userinfo" lay-filter="delete_userinfo">删除</a>
    </script>
</head>
<!-- 编辑用户信息模板 -->
<form style="display:none;width:300px;" class="layui-form" lay-filter="panel_editUserinfo" id="panel_editUserinfo"> <!-- 提示：如果你不想用form，你可以换成div等任何一个普通元素 -->
    <div class="layui-form-item" style="padding-top: 30px;">
      <label class="layui-form-label">用户名</label>
      <div class="layui-input-block">
        <input type="text" name="" value="gml" placeholder="请输入" autocomplete="off" class="layui-input" id="tb_edit_name">
      </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-block">
          <input type="text" name="" placeholder="请输入" autocomplete="off" class="layui-input" id="tb_edit_pwd">
        </div>
      </div>
    <div class="layui-form-item">
      <label class="layui-form-label">角色</label>
      <div class="layui-input-block">
        <select lay-filter="rolelist" id="rolelist">
          <option value="0">写作</option>
        </select>
      </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn layui-btn-primary" lay-submit lay-filter="editUser_cancel">取消</button>
          <button class="layui-btn" lay-submit lay-filter="editUser_commit">提交</button>
        </div>
      </div>
  </form>

<body>


<script src="./layui/layui.js"></script>
<script>
    var table_userList = null;
    var roleInfoMap = {};
    var autoInfoMap = {};
    var userCount = 0;//总用户数
    var userlistInfo = null;
    var userSelectPoint = 0;//用户数据其实查询点
    //一般直接写在一个js文件中
    layui.use(['layer', 'form','element','table','laypage'], function(){
        var layer = layui.layer,form = layui.form,ele = layui.element,table = layui.table,laypage = layui.laypage;

        //添加tab的相关处理
        ele.on('tab(mainTab)',function(data){
            console.log(data);
            let index = data.index;
            if(index == 0){
                //添加用户管理列表table
                table_userList = makeUserManagerList(table,layer,form);
                //创建翻页工具条
                laypage.render({
                    elem: 'limitBottomBar' //注意，这里的 testlaypage1 是 ID，不用加 # 号
                    ,count: 50 //数据总数，从服务端得到
                });
                //获取权限信息列表
                getAllAuth((data,err)=>{
                    if(data != null){
                        if(data.code == "0"){
                            data.data.forEach((v,i)=>{
                                autoInfoMap[v.id] = v;
                            });//赋值权限列表
                            //获取权限列表
                            getAllRoleType((data,err)=>{
                                if(data != null){
                                    if(data.code == "0"){
                                        data.data.forEach((v,i)=>{
                                            roleInfoMap[v.id] = v;
                                        });//赋值角色列表
                                        //获取用户总数
                                        getUserCount((data,err)=>{
                                            if(data != null){
                                                if(data.code == "0"){
                                                    userCount = parseInt(data.msg);
                                                    userSelectPoint = 0
                                                    //重新填充分页工具条
                                                    laypage.render({
                                                        elem: 'limitBottomBar' //注意，这里的 testlaypage1 是 ID，不用加 # 号
                                                        ,count: userCount //数据总数，从服务端得到
                                                        ,limit:15//每页显示15条数据
                                                    });
                                                    //分页获取用户信息
                                                    getAllUsers(userSelectPoint,15,(data,err)=>{
                                                        if(data != null){
                                                            if(data.code == "0"){
                                                                userlistInfo = makeUserInfo(data.data);
                                                                table_userList.reload({
                                                                    data:userlistInfo
                                                                })
                                                            }else{
                                                                console.error(data.msg);
                                                            }
                                                        }else{
                                                            console.error(err)
                                                        }
                                                    })
                                                }else{
                                                    console.error(data.msg)
                                                }
                                            }else{
                                                console.error(err)
                                            }
                                        })
                                    }else{
                                        console.error(data.msg);
                                    }
                                }else{
                                    console.error(err);
                                }
                            })
                        }else{
                            console.error(data.msg)
                        }
                    }else{
                        console.error(err);
                    }
                })
            
            }else if(index == 1){
                //调用“获取策略条件接口”
            }else if(index == 2){
                //调用“获取全部策略接口”
            }
        })
        ele.tabChange('mainTab','mUser');//默认选择第一选项"用户管理"
    });

    //一般直接写在一个js文件中
    layui.use(['element','table'], function(){
        
    });

    /**
     * 创建用户管理列表
    */
    function makeUserManagerList(table,layer,form){
        let temp_table = table.render({
                    elem:"#table_userList",
                    loading:false,
                    title:"用户列表",
                    skin:"nob",
                    even:"true",
                    size:"sm",
                    width:786,
                    cols:[
                        [
                            {field: 'signName', title: '用户名', width:160, sort: false, fixed: 'left',align:'center'},
                            {field: 'signPWD', title: '密码', width:160, sort: false, fixed: 'left',align:'center'},
                            {field: 'roleName', title: '角色', width:160, sort: false, fixed: 'left',align:'center'},
                            {width:300,title:'操作',fixed: 'left',align:'center',toolbar:'#table_userlist_barDemo'}
                        ]
                    ],
                    done: function(res, curr, count){
                        //如果是异步请求数据方式，res即为你接口返回的信息。
                        //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
                        console.log(res);

                        //得到当前页码
                        console.log(curr); 
                        
                        //得到数据总量
                        console.log(count);
                    }
                })
        //添加工具条的监听事件
        table.on("tool(lay_table_userList)",function(obj){
            let userData = obj.data;
            let evtType = obj.event;
            switch(evtType){
                case "roleinfo_des":
                    //查看角色详细描述
                    console.log("查看角色详细描述")
                    let str = "";
                    userData.authDesGroup.forEach((v,i)=>{
                        str +="</br>" + v
                    })
                    layer.open({
                        title: '拥有的的权限',
                        type:0,
                        content: str,
                        resize:false
                    });    
                    break;
                case "edit_userinfo":
                    //编辑用户信息
                    showEditUserPanel(form,layer,userData);
                    break;
                case "delete_userinfo":
                    //删除用户信息
                    console.log("删除用户信息")
                    break;
                default:break;
            }
        })
        return temp_table;
    }

    //显示用户信息编辑面板
    function showEditUserPanel(form,layer,userData){
        form.on("submit(editUser_commit)",function(reqData){
            //提交用户修改后的数据
                        let uname = tb_edit_name.value;
                        let upwd = tb_edit_pwd.value;
                        let rid = rolelist.value;
                        console.log(uname,upwd,rid);
                        layer.close(openidx);//关闭弹窗
                        updateUserInfo(userData.uid,uname,upwd,rid,(data,err)=>{
                            if(data != null){
                                if(data.code == "0"){
                                    layer.alert("更新用户信息成功")
                                    //更新页面显示
                                    //分页获取用户信息
                                    getAllUsers(userSelectPoint,15,(data,err)=>{
                                                        if(data != null){
                                                            if(data.code == "0"){
                                                                userlistInfo = makeUserInfo(data.data);
                                                                table_userList.reload({
                                                                    data:userlistInfo
                                                                })
                                                            }else{
                                                                console.error(data.msg);
                                                            }
                                                        }else{
                                                            console.error(err)
                                                        }
                                                    })
                                }else{
                                    layer.alert("跟新用户信息失败")
                                    console.error(data.msg);
                                }
                            }else{
                                layer.alert("更新用户信息失败")
                                console.error(err);
                            }
                        })
                        return false;//禁止由于提交表单造成的页面刷新
                    })
                    form.on("submit(editUser_cancel)",function(reqData){
                        //取消修改
                        layer.close(openidx);//关闭弹窗
                        return false;//禁止由于提交表单造成的页面刷新
                    })
        
                    //填充内容
                    let tb_edit_name = document.getElementById("tb_edit_name");
                    let tb_edit_pwd = document.getElementById("tb_edit_pwd");
                    let tb_edit_rolelist = document.getElementById("rolelist")
                    tb_edit_rolelist.innerText = "";
                    tb_edit_name.value = userData.signName;
                    tb_edit_pwd.value = userData.signPWD;
                    for(let rKey in roleInfoMap){
                        let option=document.createElement("option");
                        if(rKey == userData.roleID)
                            option.selected = true;//设置默认选中
                        option.setAttribute("value",rKey);
                        option.appendChild(document.createTextNode(roleInfoMap[rKey].roleName));
                        tb_edit_rolelist.appendChild(option);
                    }
                    form.render(null,"panel_editUserinfo");//刷新表单的内容

                    //弹出面板
                    let openidx = layer.open({
                        title:"编辑用户信息",
                        type:1,
                        area:['350px','350px'],
                        content: $('#panel_editUserinfo'),
                        resize:false
                    });
    }

    /**
     * 组装用户信息
     * 
    */
    function makeUserInfo(sourceUserInfo){
        let arr = [];
        sourceUserInfo.forEach((item,i)=>{
            let user = {};
            user.uid = item.id;
            user.roleID = item.roleID;
            user.signName = item.signName;
            user.signPWD = item.signPWD;
            role = roleInfoMap[user.roleID];
            if(role){
                user.roleDes = role.roleDes;
                user.roleName = role.roleName;
                user.authDesGroup = [];
                role.authGroup.split(",").forEach((authid,ai)=>{
                    let auth = autoInfoMap[authid]
                    if(auth)
                        user.authDesGroup.push(auth.authDes);
                })
            }
            arr.push(user);
        })
        return arr;
    }
</script>

<div class="layui-tab layui-tab-brief" lay-filter="mainTab">
    <ul class="layui-tab-title">
      <li lay-id="mUser">用户管理</li>
      <li lay-id="mCondition">维护策略条件</li>
      <li lay-id="mStrategy">维护策略</li>
    </ul>
    <div class="layui-tab-content">
      <div class="layui-tab-item">
        <div id="table_userList" lay-filter="lay_table_userList"></div>
        <div id="limitBottomBar"></div>
      </div>
      <div class="layui-tab-item">内容2</div>
      <div class="layui-tab-item">内容3</div>
    </div>
  </div>

</body>
</html>